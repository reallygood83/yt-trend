rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ===== Premium Users Collection =====
    // í”„ë¦¬ë¯¸ì—„ ì‚¬ìš©ì ëª©ë¡ (Firebase Consoleì—ì„œë§Œ ê´€ë¦¬)
    match /premiumUsers/{userId} {
      // ì½ê¸°: ì¸ì¦ëœ ì‚¬ìš©ìëŠ” ìì‹ ì˜ í”„ë¦¬ë¯¸ì—„ ìƒíƒœ í™•ì¸ ê°€ëŠ¥
      allow read: if request.auth != null && request.auth.uid == userId;

      // ì“°ê¸°: Firebase Consoleì—ì„œë§Œ ê°€ëŠ¥ (í´ë¼ì´ì–¸íŠ¸ ì“°ê¸° ì°¨ë‹¨)
      allow write: if false;
    }

    // ===== Learning Notes Collection =====
    // í•™ìŠµ ë…¸íŠ¸ ì €ì¥ì†Œ
    match /learningNotes/{noteId} {

      // ğŸ“– ì½ê¸° ê·œì¹™
      // 1. ë³¸ì¸ì´ ì‘ì„±í•œ ë…¸íŠ¸
      // 2. shareIdê°€ ìˆëŠ” ë…¸íŠ¸ (ê³µê°œ ê³µìœ )
      allow read: if request.auth != null && resource.data.userId == request.auth.uid;
      allow get: if resource.data.shareId != null;  // ê³µìœ  ë…¸íŠ¸ ë‹¨ê±´ ì¡°íšŒ

      // âœï¸ ì“°ê¸° ê·œì¹™ - ìƒì„±
      allow create: if request.auth != null &&
                       request.resource.data.userId == request.auth.uid &&
                       // í•„ìˆ˜ í•„ë“œ ê²€ì¦
                       request.resource.data.keys().hasAll(['userId', 'noteData', 'metadata', 'createdAt', 'shareId']) &&
                       // userIdëŠ” ì¸ì¦ëœ ì‚¬ìš©ìì™€ ì¼ì¹˜í•´ì•¼ í•¨
                       request.resource.data.userId == request.auth.uid &&
                       // shareIdëŠ” ë¬¸ìì—´ì´ì–´ì•¼ í•¨
                       request.resource.data.shareId is string &&
                       // createdAtì€ íƒ€ì„ìŠ¤íƒ¬í”„ì—¬ì•¼ í•¨
                       request.resource.data.createdAt is timestamp;

      // ğŸ”„ ì—…ë°ì´íŠ¸ ê·œì¹™
      allow update: if request.auth != null &&
                       resource.data.userId == request.auth.uid &&
                       // userId ë³€ê²½ ë¶ˆê°€
                       request.resource.data.userId == resource.data.userId;

      // ğŸ—‘ï¸ ì‚­ì œ ê·œì¹™
      allow delete: if request.auth != null &&
                       resource.data.userId == request.auth.uid;
    }

    // ===== Default Deny =====
    // ë‹¤ë¥¸ ëª¨ë“  ì»¬ë ‰ì…˜ì€ ê¸°ë³¸ì ìœ¼ë¡œ ì ‘ê·¼ ê±°ë¶€
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
